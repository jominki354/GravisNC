<Window x:Class="GCode.App.WPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:local="clr-namespace:GCode.App.WPF"
        xmlns:commands="clr-namespace:GCode.App.WPF.Commands"
        mc:Ignorable="d"
        Title="GravisNC" Height="720" Width="1080"
        Icon="Resources/icon.png"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        ResizeMode="CanResizeWithGrip">
    
    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="40" 
                      ResizeBorderThickness="5" 
                      CornerRadius="10" 
                      GlassFrameThickness="0"/>
    </WindowChrome.WindowChrome>

    <Border Background="{StaticResource WindowBackgroundBrush}" CornerRadius="10" BorderBrush="#333333" BorderThickness="1">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.5"/>
        </Border.Effect>
        
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Title Bar -->
                <RowDefinition Height="*"/>    <!-- Main Content -->
                <RowDefinition Height="24"/>   <!-- Status Bar -->
            </Grid.RowDefinitions>

            <!-- 1. TITLE BAR -->
            <Grid Grid.Row="0">
                <Border Background="#2D2D30" CornerRadius="10,10,0,0" Padding="5,0" 
                        BorderBrush="#3F3F46" BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Menu -->
                        <Menu Grid.Column="0" 
                              WindowChrome.IsHitTestVisibleInChrome="True"
                              Background="Transparent" 
                              Foreground="#CCCCCC" 
                              VerticalAlignment="Center"
                              Margin="10,0,0,0">
                            <MenuItem Header="íŒŒì¼(F)">
                                <MenuItem Command="{x:Static commands:AppCommands.NewFile}"/>
                                <MenuItem Command="{x:Static commands:AppCommands.OpenFile}"/>
                                <MenuItem Command="{x:Static commands:AppCommands.OpenFolder}"/>
                                <Separator/>
                                <MenuItem Command="{x:Static commands:AppCommands.SaveFile}"/>
                                <MenuItem Header="ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ìž¥..." Command="{x:Static commands:AppCommands.SaveAsFile}"/>
                                <Separator/>
                                <MenuItem Header="ì„¤ì •" Command="{x:Static commands:AppCommands.OpenSettings}"/>
                                <Separator/>
                                <MenuItem Header="ì¢…ë£Œ" Command="{x:Static commands:AppCommands.Exit}"/>
                            </MenuItem>
                            <MenuItem Header="íŽ¸ì§‘(E)">
                                <MenuItem Command="ApplicationCommands.Undo"/>
                                <MenuItem Command="ApplicationCommands.Redo"/>
                                <Separator/>
                                <MenuItem Command="ApplicationCommands.Cut"/>
                                <MenuItem Command="ApplicationCommands.Copy"/>
                                <MenuItem Command="ApplicationCommands.Paste"/>
                            </MenuItem>
                            <MenuItem Header="ë³´ê¸°(V)">
                                <MenuItem Command="{x:Static commands:AppCommands.ZoomIn}"/>
                                <MenuItem Command="{x:Static commands:AppCommands.ZoomOut}"/>
                                <Separator/>
                                <MenuItem Command="{x:Static commands:AppCommands.ToggleExplorer}"/>
                            </MenuItem>
                        </Menu>

                        <!-- Title -->
                        <TextBlock x:Name="TitleText" Grid.Column="1" 
                                   Text="GravisNC - ì œëª© ì—†ìŒ" 
                                   VerticalAlignment="Center" 
                                   HorizontalAlignment="Center" 
                                   Foreground="#888888" 
                                   FontSize="12"
                                   IsHitTestVisible="False"/>

                        <!-- Window Buttons -->
                        <StackPanel Grid.Column="2" 
                                    Orientation="Horizontal" 
                                    WindowChrome.IsHitTestVisibleInChrome="True">
                            <Button Content="â€”" Width="46" Height="44" 
                                    Background="Transparent" Foreground="#CCCCCC" BorderThickness="0"
                                    Click="Minimize_Click"/>
                            <Button Content="â˜" Width="46" Height="44" 
                                    Background="Transparent" Foreground="#CCCCCC" BorderThickness="0"
                                    Click="Maximize_Click"/>
                            <Button x:Name="CloseButton" Content="âœ•" Width="46" Height="44" 
                                    Background="Transparent" Foreground="#CCCCCC" BorderThickness="0"
                                    Command="{x:Static commands:AppCommands.Exit}"
                                    MouseEnter="CloseButton_MouseEnter"
                                    MouseLeave="CloseButton_MouseLeave"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <!-- 2. MAIN CONTENT AREA -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="48"/>   <!-- Activity Bar -->
                    <ColumnDefinition x:Name="ExplorerColumn" Width="200"/> <!-- Explorer -->
                    <ColumnDefinition Width="*"/>    <!-- Editor -->
                </Grid.ColumnDefinitions>

                    <!-- Activity Bar (Left Icons) -->
                    <Border Grid.Column="0" Background="#333333">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- ìƒë‹¨ ë²„íŠ¼ë“¤ -->
                            <StackPanel Grid.Row="0" VerticalAlignment="Top">
                                <Button x:Name="ExplorerBtn" Content="ðŸ“" Width="48" Height="48" 
                                        Background="Transparent" Foreground="White" BorderThickness="0" 
                                        FontSize="18" Command="{x:Static commands:AppCommands.ToggleExplorer}" ToolTip="íƒìƒ‰ê¸° (Ctrl+Shift+E)"/>
                                <Button Content="ðŸ”" Width="48" Height="48" 
                                        Background="Transparent" Foreground="#858585" BorderThickness="0" 
                                        FontSize="18" ToolTip="ê²€ìƒ‰"/>
                            </StackPanel>
                            
                            <!-- í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
                            <StackPanel Grid.Row="1" VerticalAlignment="Bottom">
                                <Button x:Name="OptimizerBtn" Content="âš™ï¸" Width="48" Height="48" 
                                        Background="Transparent" Foreground="#858585" BorderThickness="0" 
                                        FontSize="18" Click="OptimizerBtn_Click" ToolTip="ì½”ë“œ ìµœì í™”"/>
                                 
                                <!-- NEW: Structure Button -->
                                <Button x:Name="StructureBtn" Content="â˜·" Width="48" Height="48" 
                                        Background="Transparent" Foreground="#858585" BorderThickness="0" 
                                        FontSize="18" Click="StructureBtn_Click" ToolTip="ë¸”ë¡ êµ¬ì¡° (Block View)"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Explorer Panel -->
                    <Border x:Name="ExplorerPanel" Grid.Column="1" Background="#252526" BorderBrush="#1E1E1E" BorderThickness="0,0,1,0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="35"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <Grid Grid.Row="0">
                                <TextBlock Text="íƒìƒ‰ê¸°" Foreground="#BBBBBB" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" Margin="15,0,0,0"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0">
                                    <Button Width="24" Height="24"
                                            Background="Transparent" BorderThickness="0" Padding="0"
                                            ToolTip="í´ë” ì—´ê¸° (Open Folder)"
                                            Command="{x:Static commands:AppCommands.OpenFolder}">
                                        <Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" 
                                              Fill="#DDDDDD" Stretch="Uniform" Margin="6"/>
                                    </Button>
                                    <Button Width="24" Height="24"
                                            Background="Transparent" BorderThickness="0" Padding="0"
                                            ToolTip="í´ë” ë‹«ê¸° (Close Folder)"
                                            Command="{x:Static commands:AppCommands.CloseFolder}">
                                        <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" 
                                              Fill="#DDDDDD" Stretch="Uniform" Margin="6"/>
                                    </Button>
                                </StackPanel>
                            </Grid>
                            
                            <TreeView x:Name="FileTree" Grid.Row="1" Background="Transparent" BorderThickness="0" Foreground="#CCCCCC">
                                <TreeView.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="í´ë” ì—´ê¸°" Command="{x:Static commands:AppCommands.OpenFolder}"/>
                                        <MenuItem Header="íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ ì—´ê¸°" Command="{x:Static commands:AppCommands.RevealInExplorer}" 
                                                  CommandParameter="{Binding Tag, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                    </ContextMenu>
                                </TreeView.ContextMenu>
                                <TreeView.Resources>
                                    <Style TargetType="TreeViewItem">
                                        <Setter Property="Foreground" Value="#CCCCCC"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Padding" Value="4,2"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="TreeViewItem">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition MinWidth="19" Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition/>
                                                        </Grid.RowDefinitions>
                                                        
                                                        <ToggleButton x:Name="Expander" ClickMode="Press" 
                                                                      IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}">
                                                            <ToggleButton.Template>
                                                                <ControlTemplate TargetType="ToggleButton">
                                                                    <Border Width="19" Height="16" Background="Transparent">
                                                                        <Path x:Name="ExpandPath" Fill="#888888" 
                                                                              Data="M 4 0 L 8 4 L 4 8 Z" 
                                                                              VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsChecked" Value="True">
                                                                            <Setter TargetName="ExpandPath" Property="Data" Value="M 0 4 L 8 4 L 4 8 Z"/>
                                                                            <Setter TargetName="ExpandPath" Property="Fill" Value="#CCCCCC"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </ToggleButton.Template>
                                                        </ToggleButton>
                                                        
                                                        <Border x:Name="Bd" Grid.Column="1" 
                                                                Background="{TemplateBinding Background}" 
                                                                Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter x:Name="PART_Header" ContentSource="Header"/>
                                                        </Border>
                                                        
                                                        <ItemsPresenter x:Name="ItemsHost" Grid.Row="1" Grid.Column="1"/>
                                                    </Grid>
                                                    
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsExpanded" Value="false">
                                                            <Setter TargetName="ItemsHost" Property="Visibility" Value="Collapsed"/>
                                                        </Trigger>
                                                        <Trigger Property="HasItems" Value="false">
                                                            <Setter TargetName="Expander" Property="Visibility" Value="Hidden"/>
                                                        </Trigger>
                                                        
                                                        <!-- Hover -->
                                                        <Trigger Property="IsMouseOver" Value="true" SourceName="Bd">
                                                            <Setter TargetName="Bd" Property="Background" Value="#2A2D2E"/>
                                                        </Trigger>
                                                        
                                                        <!-- Selected (Inactive) -->
                                                        <Trigger Property="IsSelected" Value="true">
                                                            <Setter TargetName="Bd" Property="Background" Value="#37373D"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                        </Trigger>
                                                        
                                                        <!-- Selected + Active Focus -->
                                                        <MultiTrigger>
                                                            <MultiTrigger.Conditions>
                                                                <Condition Property="IsSelected" Value="true"/>
                                                                <Condition Property="IsSelectionActive" Value="true"/>
                                                            </MultiTrigger.Conditions>
                                                            <Setter TargetName="Bd" Property="Background" Value="#094771"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                        </MultiTrigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </TreeView.Resources>
                                <TreeViewItem Header="í´ë”ë¥¼ ì—´ì–´ì£¼ì„¸ìš”" Foreground="#888888" Selected="TreeViewItem_Selected_OpenFolder"/>
                            </TreeView>
                        </Grid>
                    </Border>
                    
                    <!-- Optimizer Panel -->
                    <Border x:Name="OptimizerPanel" Grid.Column="1" Background="#252526" BorderBrush="#1E1E1E" BorderThickness="0,0,1,0" Visibility="Collapsed">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="35"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header -->
                            <Grid Grid.Row="0">
                                <TextBlock Text="ì½”ë“œ ìµœì í™”" Foreground="#BBBBBB" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" Margin="15,0,0,0"/>
                            </Grid>
                            
                            <!-- Content -->
                            <StackPanel Grid.Row="1" Margin="10">
                                <CheckBox x:Name="ChkZigZag" Content="WCS Zig-zag ìµœì í™”" 
                                          Foreground="#CCCCCC" IsChecked="True" Margin="0,5"/>
                                
                                <TextBlock Text="ê°ì§€ëœ ê³µì •:" Foreground="#888888" FontSize="11" Margin="0,15,0,5"/>
                                <ListBox x:Name="OperationList" 
                                         Background="#1E1E1E" 
                                         BorderThickness="0" 
                                         Foreground="#CCCCCC"
                                         MaxHeight="200">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock>
                                                <Run Text="{Binding Index, StringFormat='Op{0}: '}"/>
                                                <Run Text="{Binding Name}"/>
                                                <Run Text="{Binding ToolNumber, StringFormat=' ({0})'}"/>
                                                <Run Text="{Binding WcsCount, StringFormat=' - WCS {0}ê°œ'}"/>
                                                <Run Text=" [ì—­ìˆœ]" Foreground="#4EC9B0" 
                                                     FontWeight="{Binding WillReverse, Converter={x:Null}}"/>
                                            </TextBlock>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                            
                            <!-- Buttons -->
                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="10">
                                <Button Content="ì—ë””í„°ì— ì ìš©" Padding="15,8" Margin="5"
                                        Background="#0E639C" Foreground="White" BorderThickness="0"
                                        Click="ApplyOptimization_Click"/>
                                <Button Content="ë¯¸ë¦¬ë³´ê¸°" Padding="15,8" Margin="5"
                                        Background="#3C3C3C" Foreground="#CCCCCC" BorderThickness="0"
                                        Click="PreviewOptimization_Click"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Structure Panel (Block View) -->
                    <Border x:Name="StructurePanel" Grid.Column="1" Background="#252526" BorderBrush="#1E1E1E" BorderThickness="0,0,1,0" Visibility="Collapsed">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="35"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header -->
                            <Grid Grid.Row="0">
                                <TextBlock Text="ë¸”ë¡ êµ¬ì¡° (G-Code Structure)" Foreground="#BBBBBB" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" Margin="15,0,0,0"/>
                                <Button Content="ðŸ”„" 
                                        Width="24" Height="24" HorizontalAlignment="Right" Margin="0,0,10,0"
                                        Background="Transparent" BorderThickness="0" Foreground="#CCCCCC"
                                        Click="RefreshStructure_Click"
                                        ToolTip="êµ¬ì¡° ìƒˆë¡œê³ ì¹¨"/>
                            </Grid>
                            
                            <!-- Toolbar -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="10,0,10,10">
                                <Button Content="ê³µêµ¬ë³„ ì •ë ¬" FontSize="11" Margin="0,0,5,0" Padding="8,4" Background="#3C3C3C" Click="SortByTool_Click"/>
                                <!-- Future: <Button Content="ìµœì í™”" ... /> -->
                            </StackPanel>

                            <!-- Block List -->
                            <ListBox x:Name="StructureList" 
                                     Grid.Row="2"
                                     Background="Transparent" 
                                     BorderThickness="0" 
                                     Foreground="#CCCCCC" 
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                     SelectionChanged="StructureList_SelectionChanged">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#2D2D30" CornerRadius="3" Padding="8" Margin="0,2" BorderBrush="#3E3E42" BorderThickness="1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <!-- Icon / Number -->
                                                <Border Background="#007ACC" CornerRadius="2" Width="24" Height="24" Margin="0,0,8,0" VerticalAlignment="Top">
                                                    <TextBlock Text="{Binding ToolNumber}" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                                
                                                <!-- Content -->
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding Header}" FontWeight="Bold" Foreground="#E0E0E0" FontSize="12"/>
                                                    <TextBlock Text="{Binding Operations[0]}" Foreground="#4EC9B0" FontSize="11" Margin="0,2,0,0" 
                                                               Visibility="{Binding Operations.Count, Converter={StaticResource CountToVisibilityConverter}}"/>
                                                    <TextBlock Text="{Binding Content}" Foreground="#888888" FontSize="10" 
                                                               MaxHeight="32" TextTrimming="CharacterEllipsis" Margin="0,4,0,0" Opacity="0.7"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <!-- Hint -->
                            <TextBlock Grid.Row="3" Text="* ë“œëž˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥ (êµ¬í˜„ì˜ˆì •)" 
                                       Foreground="#666666" FontSize="10" HorizontalAlignment="Center" Margin="10"/>
                        </Grid>
                    </Border>

                    <!-- Editor Area -->
                    <Grid Grid.Column="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="36"/>  <!-- Tabs -->
                            <RowDefinition Height="22"/>  <!-- Breadcrumb -->
                            <RowDefinition Height="*"/>   <!-- Editor -->
                        </Grid.RowDefinitions>
                        
                        <!-- Tab Bar -->
                        <TabControl x:Name="EditorTabs" 
                                    Grid.Row="0" Grid.RowSpan="3"
                                    Background="Transparent" 
                                    BorderThickness="0"
                                    Padding="0">
                            <!-- Tab Control Template -->
                            <TabControl.Template>
                                <ControlTemplate TargetType="TabControl">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="40"/> <!-- Increased Height -->
                                            <RowDefinition Height="22"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <!-- Tab Headers -->
                                        <Border Grid.Row="0" Background="#2D2D30" Padding="8,0,8,0">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom">
                                                <TabPanel IsItemsHost="True"/>
                                                <Button Command="{x:Static commands:AppCommands.NewFile}" 
                                                        Width="28" Height="28" 
                                                        Background="Transparent" 
                                                        BorderThickness="0" 
                                                        Margin="4,0,0,2"
                                                        Padding="0"
                                                        VerticalAlignment="Bottom"
                                                        ToolTip="ìƒˆ íƒ­ (Ctrl+N)">
                                                    <Button.Template>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border x:Name="Bd" Background="{TemplateBinding Background}" CornerRadius="3">
                                                                <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" 
                                                                      Fill="#CCCCCC" Stretch="Uniform" Margin="6" Width="10" Height="10"/>
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter TargetName="Bd" Property="Background" Value="#3E3E42"/>
                                                                    <Setter Property="Cursor" Value="Hand"/>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Button.Template>
                                                </Button>
                                            </StackPanel>
                                        </Border>
                                        <!-- Breadcrumb -->
                                        <Border Grid.Row="1" Background="#1E1E1E" BorderBrush="#333333" BorderThickness="0,0,0,1">
                                            <TextBlock x:Name="BreadcrumbText" Text="ðŸ“Ž ê²½ë¡œ ì—†ìŒ" Foreground="#888888" FontSize="12" VerticalAlignment="Center" Margin="12,0,0,0"/>
                                        </Border>
                                        <!-- Content -->
                                        <Grid Grid.Row="2" Background="{StaticResource EditorBackgroundBrush}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="80"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <ContentPresenter Grid.Column="0" ContentSource="SelectedContent"/>
                                            
                                            <Border Grid.Column="1" Background="#1E1E1E" BorderBrush="#333333" BorderThickness="1,0,0,0">
                                                <ScrollViewer x:Name="MinimapScrollViewer" VerticalScrollBarVisibility="Hidden" HorizontalScrollBarVisibility="Disabled" Focusable="False">
                                                    <Canvas x:Name="MinimapCanvas" Background="Transparent" Width="78" HorizontalAlignment="Left" VerticalAlignment="Top" Focusable="False" MouseLeftButtonDown="Minimap_MouseDown" MouseMove="Minimap_MouseMove" MouseLeftButtonUp="Minimap_MouseUp">
                                                        <Border x:Name="MinimapViewport" Background="#1FFFFFFF" Width="78" Height="0" Canvas.Top="0" IsHitTestVisible="False" Focusable="False"/>
                                                    </Canvas>
                                                </ScrollViewer>
                                            </Border>
                                        </Grid>
                                    </Grid>
                                </ControlTemplate>
                            </TabControl.Template>
                            <TabControl.Resources>
                                <Style TargetType="TabItem">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="AllowDrop" Value="True"/>
                                    <EventSetter Event="PreviewMouseLeftButtonDown" Handler="TabItem_PreviewMouseLeftButtonDown"/>
                                    <EventSetter Event="PreviewMouseMove" Handler="TabItem_PreviewMouseMove"/>
                                    <EventSetter Event="Drop" Handler="TabItem_Drop"/>
                                    <EventSetter Event="DragOver" Handler="TabItem_DragOver"/>
                                    <EventSetter Event="DragLeave" Handler="TabItem_DragLeave"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="TabItem">
                                                <Grid>
                                                    <!-- Drop Indicator -->
                                                    <Border x:Name="DropIndicator" 
                                                            Width="3" 
                                                            Background="#007ACC" 
                                                            HorizontalAlignment="Left" 
                                                            Margin="-2,4,0,4"
                                                            CornerRadius="1"
                                                            Visibility="Collapsed"/>
                                                    <Border x:Name="Bd" 
                                                            Background="{TemplateBinding Background}" 
                                                            Padding="20,12" 
                                                            Margin="0,0,3,0"
                                                            CornerRadius="4,4,0,0"
                                                            MinHeight="44">
                                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                            <TextBlock Text="ðŸ“„" Foreground="#888888" FontSize="14" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                                            <ContentPresenter ContentSource="Header" VerticalAlignment="Center" TextElement.FontSize="14"/>
                                                        <Button Background="Transparent" 
                                                                 BorderThickness="0"
                                                                 Margin="8,0,0,0"
                                                                 Padding="0"
                                                                 Width="18" Height="18"
                                                                 Click="CloseTab_Click"
                                                                 Tag="{Binding RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                                 ToolTip="ë‹«ê¸°">
                                                            <Button.Template>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="BtnBd" Background="Transparent" CornerRadius="2">
                                                                        <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" 
                                                                              Fill="#888888" Stretch="Uniform" Margin="4"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="BtnBd" Property="Background" Value="#444444"/>
                                                                            <Setter Property="Cursor" Value="Hand"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Button.Template>
                                                        </Button>
                                                        </StackPanel>
                                                    </Border>
                                                </Grid>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="Bd" Property="Background" Value="#1E1E1E"/>
                                                        <Setter Property="Foreground" Value="#FFFFFF"/>
                                                        <Setter Property="Panel.ZIndex" Value="1"/> <!-- Bring to front -->
                                                    </Trigger>
                                                    <Trigger Property="IsSelected" Value="False">
                                                        <Setter TargetName="Bd" Property="Background" Value="#2D2D30"/>
                                                        <Setter Property="Foreground" Value="#969696"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Foreground" Value="#EEEEEE"/>
                                                    </Trigger>
                                                    <MultiTrigger>
                                                        <MultiTrigger.Conditions>
                                                            <Condition Property="IsSelected" Value="False"/>
                                                            <Condition Property="IsMouseOver" Value="True"/>
                                                        </MultiTrigger.Conditions>
                                                        <Setter TargetName="Bd" Property="Background" Value="#3E3E42"/>
                                                    </MultiTrigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </TabControl.Resources>
                        </TabControl>
                        
                        <!-- Find/Replace Widget (VS Code exact: findWidget.css) -->
                        <Border x:Name="FindReplacePanel" 
                                Grid.Row="0" Grid.RowSpan="3"
                                VerticalAlignment="Top" HorizontalAlignment="Right"
                                Background="#252526" 
                                BorderBrush="#454545" 
                                BorderThickness="1,0,1,1"
                                CornerRadius="0,0,4,4"
                                Margin="0,58,20,0"
                                Padding="4"
                                Visibility="Collapsed">
                            <Border.Effect>
                                <DropShadowEffect ShadowDepth="0" BlurRadius="8" Color="Black" Opacity="0.4"/>
                            </Border.Effect>
                        <StackPanel Grid.IsSharedSizeScope="True">
                                <!-- Find Part (VS Code: margin 3px 25px 0 17px) -->
                                <Grid x:Name="FindRow" Margin="0,3,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="ToggleCol"/>
                                        <ColumnDefinition Width="Auto"/> <!-- Changed from * to Auto for tight layout -->
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="StatusCol"/>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="ActionCol"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Toggle Replace Button -->
                                    <Button x:Name="ToggleReplaceBtn" 
                                            Grid.Column="0"
                                            Width="22" Height="22"
                                            Background="Transparent" 
                                            BorderThickness="0"
                                            Padding="0" 
                                            Margin="0,0,4,0"
                                            VerticalAlignment="Center"
                                            Click="ToggleReplace_Click" 
                                            ToolTip="ë°”ê¾¸ê¸° í† ê¸€">
                                        <Path x:Name="TogglePath" Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" 
                                              Fill="#CCCCCC" Stretch="Uniform" Margin="5"
                                              RenderTransformOrigin="0.5,0.5">
                                             <Path.RenderTransform>
                                                 <RotateTransform Angle="0"/>
                                             </Path.RenderTransform>
                                        </Path>
                                    </Button>
                                    
                                    <!-- Find Input -->
                                    <Border Grid.Column="1" 
                                            Width="220"
                                            Background="#3C3C3C" 
                                            BorderBrush="#5A5A5A" 
                                            BorderThickness="1"
                                            CornerRadius="2"
                                            Margin="0,0,0,0">
                                        <TextBox x:Name="FindTextBox" 
                                                 Background="Transparent" 
                                                 Foreground="#CCCCCC" 
                                                 BorderThickness="0" 
                                                 CaretBrush="#CCCCCC"
                                                 Padding="6,3"
                                                 MinHeight="25"
                                                 VerticalContentAlignment="Center"
                                                 FontSize="13"
                                                 KeyDown="FindTextBox_KeyDown"/>
                                    </Border>
                                    
                                    <!-- Match Count -->
                                    <TextBlock x:Name="FindStatus" 
                                               Grid.Column="2"
                                               Foreground="#888888" 
                                               FontSize="12" 
                                               VerticalAlignment="Center"
                                               Margin="6,0,6,0"
                                               TextAlignment="Center"/>
                                    
                                    <!-- Find Actions -->
                                    <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                                        <Button Content="ìœ„ë¡œ" 
                                                Style="{StaticResource FindWidgetButtonStyle}"
                                                Click="FindPrevious_Click" 
                                                ToolTip="ì´ì „ ê²°ê³¼ (Shift+F3)"/>
                                        <Button Content="ì•„ëž˜ë¡œ" 
                                                Style="{StaticResource FindWidgetButtonStyle}"
                                                Click="FindNext_Click" 
                                                ToolTip="ë‹¤ìŒ ê²°ê³¼ (F3)"/>
                                        <Button Content="ë‹«ê¸°" 
                                                Style="{StaticResource FindWidgetButtonStyle}"
                                                Click="CloseFind_Click" 
                                                ToolTip="ë‹«ê¸° (Esc)"/>
                                    </StackPanel>
                                </Grid>
                                
                                <!-- Replace Part (hidden by default) -->
                                <Grid x:Name="ReplaceRow" Height="Auto" Margin="0,4,0,0" Visibility="Collapsed">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="ToggleCol"/>
                                        <ColumnDefinition Width="Auto"/> <!-- Auto width -->
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="StatusCol"/>
                                        <ColumnDefinition Width="Auto" SharedSizeGroup="ActionCol"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Replace Input -->
                                    <Border Grid.Column="1" 
                                            Width="220"
                                            Background="#3C3C3C" 
                                            BorderBrush="#5A5A5A" 
                                            BorderThickness="1"
                                            CornerRadius="2"
                                            Margin="0,0,0,0">
                                        <TextBox x:Name="ReplaceTextBox" 
                                                 Background="Transparent" 
                                                 Foreground="#CCCCCC" 
                                                 BorderThickness="0"
                                                 CaretBrush="#CCCCCC"
                                                 Padding="6,3"
                                                 MinHeight="25"
                                                 VerticalContentAlignment="Center"
                                                 FontSize="13"/>
                                    </Border>
                                    
                                    <!-- Replace Actions (Align to Right) -->
                                    <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Top">
                                        <Button Content="ë°”ê¾¸ê¸°" 
                                                Style="{StaticResource FindWidgetActionButtonStyle}"
                                                Click="ReplaceOne_Click" 
                                                ToolTip="í˜„ìž¬ í•­ëª© ë°”ê¾¸ê¸°"/>
                                        <Button Content="ëª¨ë‘" 
                                                Style="{StaticResource FindWidgetActionButtonStyle}"
                                                Click="ReplaceAll_Click" 
                                                ToolTip="ëª¨ë“  í•­ëª© ë°”ê¾¸ê¸°"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Grid>

                <!-- ========== 3. STATUS BAR ========== -->
                <Border Grid.Row="2" Background="#3E3E42" CornerRadius="0,0,10,10" BorderBrush="#555555" BorderThickness="0,1,0,0">
                    <Grid Margin="12,0">
                        <TextBlock Text="ì¤€ë¹„ (Ready)" VerticalAlignment="Center" Foreground="#CCCCCC" FontSize="12"/>
                        <TextBlock x:Name="StatusText" Text="Ln 1, Col 1" VerticalAlignment="Center" HorizontalAlignment="Right" Foreground="#CCCCCC" FontSize="12"/>
                    </Grid>
                </Border>
            </Grid>
        </Border>
</Window>
